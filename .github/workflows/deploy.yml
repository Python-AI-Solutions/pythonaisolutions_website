# Cloudflare Pages Deployment
#
# Prerequisites (managed in parent cloudflare-management repo):
# - Cloudflare Pages project "pythonaisolutions-website" created via Terraform
# - DNS CNAME www.pythonaisolutions.com â†’ pythonaisolutions-website.pages.dev
# - Custom domain configured in Pages project
#
# GitHub secret required:
# - CF_API_KEY: Cloudflare API token with Pages Edit permission

name: Deploy to Cloudflare Pages

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  deployments: write
  pull-requests: write

env:
  PROJECT_NAME: pythonaisolutions-website
  BUILD_DIR: out

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies with retry
        run: |
          for i in 1 2 3; do
            npm install && break || sleep 10
          done

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm run test:ci

      - name: Validate team images exist
        run: npm run validate:images

      - name: Build static site
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "âœ… Build successful - $BUILD_DIR directory exists"
            echo "Build size: $(du -sh $BUILD_DIR | cut -f1)"
          else
            echo "âŒ Build failed - $BUILD_DIR directory not found"
            exit 1
          fi

      - name: Validate assets
        run: |
          echo "ðŸ” Running asset validation..."
          npm run check-assets
          echo "âœ… Asset validation completed successfully"

      - name: Security scan of build output
        run: |
          echo "ðŸ›¡ï¸ Scanning build output for security issues..."
          find $BUILD_DIR -type f \( -name "*.js" -o -name "*.html" -o -name "*.css" \) | \
            xargs grep -l -i -E "(api[_-]?key|secret|password|token)" || echo "No secrets detected in build"

          find $BUILD_DIR -name "*.html" | xargs grep -h -o 'src="http://[^"]*"' | \
            sed 's/src="//;s/"//' | sort | uniq | while read -r url; do
              echo "âš ï¸  Insecure HTTP resource found: $url"
            done || echo "No insecure HTTP resources found"

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Deploy preview
        if: ${{ github.event_name == 'pull_request' }}
        id: cloudflare-preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
        run: |
          output=$(wrangler pages deploy ./${{ env.BUILD_DIR }} --project-name ${{ env.PROJECT_NAME }} --branch ${{ github.head_ref }})
          echo "$output"
          url=$(echo "$output" | grep -o 'https://[^ ]*\.pages\.dev' | head -1)
          echo "preview_url=$url" >> $GITHUB_OUTPUT

      - name: Comment PR with preview link
        if: ${{ github.event_name == 'pull_request' && steps.cloudflare-preview.outputs.preview_url }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const previewUrl = '${{ steps.cloudflare-preview.outputs.preview_url }}';
            
            const comment = `## ðŸš€ Preview Deployed!
            
            **Preview URL:** ${previewUrl}
            
            **Commit:** \`${sha}\`
            **Status:** âœ… Ready
            
            This preview will be automatically updated when you push new commits.`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Cloudflare Pages Preview')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }

      - name: Deploy production
        if: ${{ github.event_name == 'push' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_KEY }}
        run: wrangler pages deploy ./${{ env.BUILD_DIR }} --project-name ${{ env.PROJECT_NAME }} --branch main --commit-dirty=true
